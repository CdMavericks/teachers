<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClassSight â€” Dashboard</title>

    <link rel="stylesheet" href="styles.css" />

    <style>
      .shell {
        max-width: 1100px;
        margin: 30px auto;
        padding: 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        align-items: start;
      }
      .photo {
        width: 260px;
        height: 260px;
        border-radius: 12px;
        object-fit: cover;
        display: block;
        margin: 0 auto;
      }
      .card-center {
        text-align: center;
        padding: 18px;
      }
      .label {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
      }
      .value {
        font-weight: 700;
        margin-top: 4px;
      }
      .btn {
        padding: 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      .primary {
        background: #06b6d4;
        color: #042028;
        width: 100%;
      }
      .danger {
        background: #ff6961;
        color: #fff;
        width: 100%;
      }
      #loading {
        text-align: center;
        margin-top: 120px;
        color: #9fb6c2;
        font-size: 18px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar">
      <div class="nav-inner">
        <div class="nav-left">
          <span class="nav-title">ClassSight</span>
        </div>
      </div>
    </nav>

    <div id="loading">Loading dashboard...</div>

    <main class="shell" id="dashboard" style="display: none">
      <h2>Your Dashboard</h2>
      <p class="muted">Profile and enrolled photo are shown below.</p>

      <div class="grid">
        <div class="card card-center">
          <img
            id="profilePhoto"
            class="photo"
            src="assets/no-image.png"
            alt="Profile Photo"
          />
          <p style="margin-top: 12px">
            <button id="reEnrollBtn" class="btn primary">
              Re-Enroll Photo
            </button>
          </p>
        </div>

        <div class="card">
          <h3 id="displayName">Student</h3>

          <div style="display: flex; gap: 20px; margin-top: 12px">
            <div>
              <p class="label">USN</p>
              <p id="displayUsn" class="value">-</p>
            </div>
            <div>
              <p class="label">Branch</p>
              <p id="displayBranch" class="value">-</p>
            </div>
            <div>
              <p class="label">Section</p>
              <p id="displaySection" class="value">-</p>
            </div>
          </div>

          <div style="margin-top: 18px; display: flex; gap: 10px">
            <button id="editProfileBtn" class="btn primary">
              Edit Profile
            </button>
            <button id="logoutBtn" class="btn danger">Log Out</button>
          </div>

          <div style="margin-top: 20px">
            <h4>Coming Soon</h4>
            <p class="muted">
              Attendance, analytics, and summary pages will appear here.
            </p>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBujiz5R1qEHcLvlMp9fQIViIMuWs3gRZk",
        authDomain: "cam-attendance-a4881.firebaseapp.com",
        projectId: "cam-attendance-a4881",
        storageBucket: "cam-attendance-a4881.appspot.com",
        messagingSenderId: "344849505667",
        appId: "1:344849505667:web:9a8ddb0a009f458fca2ab6",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const STATUS_URL = "http://localhost:5000/status";

      const loading = document.getElementById("loading");
      const dashboard = document.getElementById("dashboard");

      const profilePhoto = document.getElementById("profilePhoto");
      const displayName = document.getElementById("displayName");
      const displayUsn = document.getElementById("displayUsn");
      const displayBranch = document.getElementById("displayBranch");
      const displaySection = document.getElementById("displaySection");

      const reEnrollBtn = document.getElementById("reEnrollBtn");
      const editProfileBtn = document.getElementById("editProfileBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      // fallback for broken cloudinary links
      profilePhoto.onerror = () => {
        profilePhoto.src = "assets/no-image.png";
      };

      // Guard: if they somehow reached here manually
      if (!localStorage.getItem("currentUserUid")) {
        window.location.href = "index.html";
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        if (!user.email.toLowerCase().endsWith("@nmamit.in")) {
          await signOut(auth);
          window.location.href = "index.html";
          return;
        }

        try {
          const r = await fetch(
            `${STATUS_URL}?userId=${encodeURIComponent(user.uid)}`
          );
          const data = await r.json();

          if (!data || data.status !== "success") {
            window.location.href = "index.html";
            return;
          }

          // Redirect only for incomplete first-time flow
          if (!data.profileSaved) {
            window.location.href = "form.html";
            return;
          }
          if (!data.photoEnrolled) {
            window.location.href = "upload.html";
            return;
          }

          // SHOW DASHBOARD
          loading.style.display = "none";
          dashboard.style.display = "block";

          const info = data.student_info || {};
          const enroll = data.enrollment || {};

          // Format name: make first letter uppercase
          if (info.student_name) {
            displayName.textContent = info.student_name
              .split(" ")
              .map((p) => p[0] + p.slice(1).toLowerCase())
              .join(" ");
          } else {
            displayName.textContent = "Student";
          }

          displayUsn.textContent = info.usn || "-";
          displayBranch.textContent = info.student_branch || "-";
          displaySection.textContent = info.student_section || "-";

          profilePhoto.src = enroll.url_frontal || "assets/no-image.png";
        } catch (e) {
          window.location.href = "index.html";
        }
      });

      reEnrollBtn.addEventListener("click", () => {
        window.location.href = "upload.html";
      });

      editProfileBtn.addEventListener("click", () => {
        window.location.href = "form.html?edit=true";
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        localStorage.clear();
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
