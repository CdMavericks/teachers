<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ClassSight — Complete Profile</title>

  <link rel="stylesheet" href="styles.css" />
  <style>
    .container{max-width:800px;margin:28px auto;padding:18px;}
    label{display:block;margin-top:10px;color:var(--muted);}
    .row{display:flex;gap:12px;}
    .col{flex:1;}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600;}
    .primary{background:#06b6d4;color:#042028;}
    .muted{color:var(--muted);font-size:13px;}
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="nav-inner">
      <div class="nav-left"><span class="nav-title">ClassSight</span></div>
    </div>
  </nav>

  <main class="container card">
    <h2>Complete your profile</h2>

    <!-- BACK TO DASHBOARD (edit mode only) -->
    <button id="backBtn" class="btn"
      style="background:transparent;border:1px solid rgba(255,255,255,0.1);
             color:var(--muted);margin-bottom:10px;display:none;">
      ← Back to Dashboard
    </button>

    <p class="muted">We will NOT use Google name. Enter your correct full name.</p>

    <!-- NAME -->
    <label for="nameInput">Full Name</label>
    <input id="nameInput" class="form-input" type="text" placeholder="e.g. M K Subrahmanya" />

    <!-- USN -->
    <label for="usnInput">USN</label>
    <input id="usnInput" class="form-input" type="text" maxlength="16" />

    <label for="branchInput">Branch</label>
    <input id="branchInput" class="form-input" type="text" />

    <div class="row">
      <div class="col">
        <label for="yearInput">Academic Year</label>
        <input id="yearInput" class="form-input" type="number" readonly />
      </div>
      <div class="col">
        <label for="studentYearInput">Student Year</label>
        <input id="studentYearInput" class="form-input" type="text" readonly />
      </div>
    </div>

    <label for="sectionSelect">Section</label>
    <select id="sectionSelect" class="form-input">
      <option value="" disabled selected>Select Section</option>
    </select>

    <div style="display:flex;gap:10px;margin-top:14px;">
      <button id="saveBtn" class="btn primary">Save Profile</button>
      <button id="cancelBtn" class="btn"
        style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);">
        Cancel
      </button>
    </div>

    <p id="statusMsg" class="muted" style="margin-top:12px;"></p>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBujiz5R1qEHcLvlMp9fQIViIMuWs3gRZk",
      authDomain: "cam-attendance-a4881.firebaseapp.com",
      projectId: "cam-attendance-a4881",
      storageBucket: "cam-attendance-a4881.appspot.com",
      messagingSenderId: "344849505667",
      appId: "1:344849505667:web:9a8ddb0a009f458fca2ab6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const SAVE_URL = "http://localhost:5000/saveStudentInfo";
    const STATUS_URL = "http://localhost:5000/status";
    const CURRENT_YEAR = 2025;

    const nameInput = document.getElementById("nameInput");
    const usnInput = document.getElementById("usnInput");
    const branchInput = document.getElementById("branchInput");
    const yearInput = document.getElementById("yearInput");
    const studentYearInput = document.getElementById("studentYearInput");
    const sectionSelect = document.getElementById("sectionSelect");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const backBtn = document.getElementById("backBtn");
    const statusMsg = document.getElementById("statusMsg");

    // detect edit mode
    const url = new URL(window.location.href);
    const isEditMode = url.searchParams.get("edit") === "true";

    if (isEditMode) backBtn.style.display = "inline-block";

    backBtn.addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });

    "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l => {
      const o = document.createElement("option");
      o.value = l; o.textContent = l;
      sectionSelect.appendChild(o);
    });

    function parseUSN(email){
      const res={raw:"",batch:null,branch:""};
      const local=(email.split("@")[0]||"").toUpperCase();
      res.raw=local;
      const m = local.match(/^([A-Z]{3})(\d{2})([A-Z]{2})(\d{3})$/);
      if(m){res.batch=parseInt(m[2]);res.branch=m[3];}
      return res;
    }

    function computeStudentYear(batch){
      if(!batch) return "";
      return String(CURRENT_YEAR - (2000+batch) + 1);
    }

    function cleanName(raw){
      if(!raw) return "";
      let parts = raw.trim().split(" ");
      if(parts.length>1 && /^[A-Z0-9]+$/.test(parts[0])) parts.shift();
      return parts.map(p=>p[0] + p.slice(1).toLowerCase()).join(" ");
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){window.location.href="index.html";return;}
      if(!user.email.endsWith("@nmamit.in")){await signOut(auth);window.location.href="index.html";return;}

      localStorage.setItem("currentUserUid", user.uid);
      localStorage.setItem("currentUserEmail", user.email);

      const parsed = parseUSN(user.email);

      usnInput.value = user.email.split("@")[0].slice(0,10).toUpperCase();
      branchInput.value = parsed.branch || "";
      yearInput.value = CURRENT_YEAR;
      studentYearInput.value = computeStudentYear(parsed.batch);

      const r = await fetch(`${STATUS_URL}?userId=${user.uid}`);
      const data = await r.json();

      if(data.status==="success"){
        // ONLY redirect if first time, NOT edit mode
        if(!isEditMode){
          if(data.profileSaved && data.photoEnrolled){
            window.location.href="dashboard.html";
            return;
          }
        }

        if(data.student_info){
          const info=data.student_info;
          nameInput.value = cleanName(info.student_name);
          usnInput.value = info.usn;
          branchInput.value = info.student_branch;
          if(info.student_section) sectionSelect.value = info.student_section;
        }
      }
    });

    // SAVE PROFILE
    saveBtn.addEventListener("click", async()=>{
      const name=nameInput.value.trim();
      const usn=usnInput.value.trim().toUpperCase();
      const branch=branchInput.value.trim();
      const section=sectionSelect.value;

      if(!name || !usn || !branch || !section){
        alert("All fields required."); return;
      }

      const payload={
        userId:localStorage.getItem("currentUserUid"),
        usn,
        studentName:name,
        studentBranch:branch,
        studentSection:section
      };

      saveBtn.disabled=true;
      statusMsg.textContent="Saving...";

      const r=await fetch(SAVE_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      const data = await r.json();

      if(data.status==="success"){
        if(isEditMode){
          statusMsg.textContent="Profile updated!";
          setTimeout(()=>window.location.href="dashboard.html",600);
        } else {
          statusMsg.textContent="Profile saved! Continue to enrollment...";
          setTimeout(()=>window.location.href="upload.html",600);
        }
      } else {
        statusMsg.textContent="Error: " + data.error;
        saveBtn.disabled=false;
      }
    });

    cancelBtn.addEventListener("click",()=>{
      if(isEditMode){
        window.location.href="dashboard.html";
      } else {
        // first time setup → no dashboard yet → logout
        window.location.href="index.html";
      }
    });

  </script>
</body>
</html>
