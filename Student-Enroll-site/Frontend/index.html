<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ClassSight — Sign In</title>

  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body{
      margin:0;
      font-family:Inter,system-ui;
      background: #020617;
      color:#eaf6fb;
      display:flex;
      justify-content:center;
      padding-top:120px;
    }
    .card{
      background:rgba(6,8,12,0.72);
      padding:28px;
      border-radius:12px;
      width:420px;
      text-align:center;
      box-shadow:0 12px 40px rgba(2,6,23,0.6);
    }
    .google-btn{
      background:#06b6d4;
      border:none;
      padding:12px;
      border-radius:10px;
      color:#042028;
      font-weight:700;
      cursor:pointer;
      width:100%;
      font-size:15px;
    }
    .small{ color:#9fb6c2; margin-top:10px; }
    .error{ color:#ffb4b4; margin-top:8px; display:none; }
  </style>
</head>

<body>

  <div class="card">
    <h1 style="margin:0 0 8px 0;">ClassSight</h1>
    <p class="small">Sign in using your official <strong>@nmamit.in</strong> account.</p>

    <button id="googleLoginBtn" class="google-btn" style="margin-top:16px;">Sign in with Google</button>

    <p id="statusText" class="small" style="margin-top:12px;"></p>
    <p id="err" class="error"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBujiz5R1qEHcLvlMp9fQIViIMuWs3gRZk",
      authDomain: "cam-attendance-a4881.firebaseapp.com",
      projectId: "cam-attendance-a4881",
      storageBucket: "cam-attendance-a4881.appspot.com",
      messagingSenderId: "344849505667",
      appId: "1:344849505667:web:9a8ddb0a009f458fca2ab6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ hd: "nmamit.in" });

    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const statusText = document.getElementById("statusText");
    const err = document.getElementById("err");

    const STATUS_URL = "http://localhost:5000/status";

    googleLoginBtn.addEventListener("click", async () => {
      err.style.display = "none";
      statusText.textContent = "";

      googleLoginBtn.disabled = true;

      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        err.style.display = "block";
        err.textContent = "Sign-in failed: " + (e.message || e);
      }

      googleLoginBtn.disabled = false;
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      // Wrong domain → kick
      if (!user.email.toLowerCase().endsWith("@nmamit.in")) {
        err.style.display = "block";
        err.textContent = "Please use your @nmamit.in college Gmail.";
        await signOut(auth);
        return;
      }

      statusText.textContent = "Checking account status...";

      try {
        const r = await fetch(`${STATUS_URL}?userId=${encodeURIComponent(user.uid)}`);
        const data = await r.json();

        const profileSaved = !!data.profileSaved;
        const photoEnrolled = !!data.photoEnrolled;

        // Store only after valid sign-in, not before
        localStorage.setItem("currentUserUid", user.uid);
        localStorage.setItem("currentUserEmail", user.email);

        // Flow logic:
        if (!profileSaved) {
          statusText.textContent = "Redirecting to profile setup...";
          setTimeout(() => (window.location.href = "form.html"), 200);
          return;
        }

        if (!photoEnrolled) {
          statusText.textContent = "Redirecting to photo enrollment...";
          setTimeout(() => (window.location.href = "upload.html"), 200);
          return;
        }

        statusText.textContent = "Redirecting to dashboard...";
        setTimeout(() => (window.location.href = "dashboard.html"), 200);

      } catch (e) {
        err.style.display = "block";
        err.textContent = "Couldn't verify status: " + (e.message || e);
        await signOut(auth);
      }
    });
  </script>
</body>
</html>
