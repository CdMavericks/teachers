<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face Enrollment</title>

  <link rel="stylesheet" href="styles.css" />

  <!-- Mediapipe for Camera -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<body class="faceid-bg">

  <div class="ui-shell">

    <button id="cancel-btn" class="cancel-btn">Cancel</button>

    <h1 class="title">Face Enrollment</h1>
    <p id="instruction" class="instruction">Step 1 of 5 — Look Straight</p>

    <!-- CAMERA CIRCLE -->
    <div class="camera-container">
      <video id="video" autoplay muted playsinline></video>
    </div>

    <!-- CAPTURE BUTTON -->
    <button id="capture-btn" class="capture-btn">Capture</button>

    <!-- THUMBNAILS -->
    <div class="thumbnail-row">

      <div id="thumb-frontal" class="thumbnail-box" data-pose="frontal"></div>
      <div id="thumb-left" class="thumbnail-box" data-pose="left"></div>
      <div id="thumb-right" class="thumbnail-box" data-pose="right"></div>
      <div id="thumb-up" class="thumbnail-box" data-pose="up"></div>
      <div id="thumb-down" class="thumbnail-box" data-pose="down"></div>

    </div>

    <!-- DONE -->
    <div class="done-wrap">
      <button id="done-btn" class="done-btn" disabled>Done</button>
    </div>

    <!-- HIDDEN CANVAS FOR SNAPSHOTS -->
    <canvas id="snapCanvas" style="display:none;"></canvas>

  </div>


  <script type="module">

    /* =============================
       CAMERA START
    ============================== */

    const video = document.getElementById("video");

    async function startCam() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 480, height: 480 }
      });

      video.srcObject = stream;
    }

    startCam();


    /* =============================
       MANUAL CAPTURE LOGIC
    ============================== */

    const snapCanvas = document.getElementById("snapCanvas");
    const snapCtx = snapCanvas.getContext("2d");

    const captureBtn = document.getElementById("capture-btn");
    const doneBtn = document.getElementById("done-btn");
    const instruction = document.getElementById("instruction");

    const poses = ["frontal", "left", "right", "up", "down"];
    let currentIndex = 0;

    const instructionsText = {
      frontal: "Step 1 of 5 — Look Straight",
      left: "Step 2 of 5 — Turn Left",
      right: "Step 3 of 5 — Turn Right",
      up: "Step 4 of 5 — Look Up",
      down: "Step 5 of 5 — Look Down"
    };

    const captured = {
      frontal: null,
      left: null,
      right: null,
      up: null,
      down: null
    };

    function updateInstruction() {
      const pose = poses[currentIndex];
      instruction.textContent = instructionsText[pose];
    }

    updateInstruction();


    /* =============================
       CAPTURE PHOTO
    ============================== */

    captureBtn.addEventListener("click", () => {
      const pose = poses[currentIndex];

      // Draw frame onto canvas
      snapCanvas.width = video.videoWidth;
      snapCanvas.height = video.videoHeight;

      snapCtx.save();
      snapCtx.translate(video.videoWidth, 0);
      snapCtx.scale(-1, 1);
      snapCtx.drawImage(video, 0, 0);
      snapCtx.restore();

      const imgURL = snapCanvas.toDataURL("image/jpeg", 0.95);
      captured[pose] = imgURL;

      // Update thumbnail
      const thumb = document.getElementById(`thumb-${pose}`);
      thumb.classList.add("filled");

      let img = document.createElement("img");
      img.src = imgURL;
      thumb.innerHTML = "";
      thumb.appendChild(img);

      // Move to next pose
      if (currentIndex < poses.length - 1) {
        currentIndex++;
        updateInstruction();
      }

      checkCompletion();
    });


    /* =============================
       CLICK THUMBNAIL → RETAKE
    ============================== */

    document.querySelectorAll(".thumbnail-box").forEach(box => {
      box.addEventListener("click", () => {
        const pose = box.dataset.pose;

        // Set this pose as current
        currentIndex = poses.indexOf(pose);
        updateInstruction();
      });
    });


    /* =============================
       CHECK COMPLETION
    ============================== */

    function checkCompletion() {
      const allFilled = Object.values(captured).every(v => v !== null);
      doneBtn.disabled = !allFilled;
    }


    /* =============================
       CANCEL BUTTON
    ============================== */

    document.getElementById("cancel-btn").addEventListener("click", () => {
      location.href = "index.html";
    });


    /* =============================
       SUBMIT TO SERVER
    ============================== */

    const BACKEND_URL = "http://localhost:5000/enroll";

    doneBtn.addEventListener("click", async () => {
      doneBtn.textContent = "Uploading…";
      doneBtn.disabled = true;

      const userId = localStorage.getItem("currentUserUid");
      const email = localStorage.getItem("currentUserEmail");

      const studentName = localStorage.getItem("studentName");
      const studentBranch = localStorage.getItem("studentBranch");
      const studentSection = localStorage.getItem("studentSection");

      const usn = email.slice(0, 10).toUpperCase();

      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId,
            usn,
            studentName,
            studentBranch,
            studentSection,
            images: [
              captured.frontal,
              captured.left,
              captured.right,
              captured.up,
              captured.down
            ]
          })
        });

        const result = await res.json();

        if (result.status === "success") {
          alert("Enrollment completed successfully!");
        } else {
          alert("Server Error: " + result.error);
        }

      } catch (err) {
        alert("Connection Error: " + err.message);
      }

      doneBtn.textContent = "Done";
      doneBtn.disabled = false;
    });

  </script>

</body>
</html>
