<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ClassSight — Photo Enrollment</title>

  <link rel="stylesheet" href="styles.css" />
  <style>
    .shell{max-width:880px;margin:22px auto;padding:18px;}
    .camera{width:360px;height:360px;border-radius:50%;overflow:hidden;margin:0 auto;background:#000;display:flex;align-items:center;justify-content:center;}
    video{width:100%;height:100%;object-fit:cover;}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600;}
    .primary{background:#06b6d4;color:#042028;}
    .green{background:#33d176;color:#042028;}
    .muted{color:var(--muted);}
    .existing{width:260px;height:260px;border-radius:12px;object-fit:cover;display:block;margin:10px auto;}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-inner">
      <div class="nav-left">
        <span class="nav-title">ClassSight</span>
      </div>
    </div>
  </nav>

  <main class="shell card">

    <!-- ✔ Back button -->
    <button id="backBtn" class="btn"
      style="background:transparent;border:1px solid rgba(255,255,255,0.15);
             color:var(--muted);margin-bottom:14px;display:none;">
      ← Back to Dashboard
    </button>

    <h2>Photo Enrollment</h2>
    <p class="muted">Capture one clean frontal photo. Existing enrolled photo is shown below.</p>

    <!-- CAMERA -->
    <div class="camera" id="cameraWrap">
      <video id="video" autoplay muted playsinline></video>
    </div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
      <button id="captureBtn" class="btn primary">Capture</button>
      <button id="uploadBtn" class="btn green" disabled>Upload & Save</button>
      <button id="retakeBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);">Retake</button>
    </div>

    <div style="height:1px;background:rgba(255,255,255,0.06);margin:18px 0;"></div>

    <h3 style="text-align:center;margin-bottom:8px;">Your Current Enrolled Photo</h3>

    <img id="existingImg" class="existing" 
         src="https://placehold.co/260x260?text=No+Photo"
         alt="Existing photo">

    <p id="statusMsg" class="muted" style="text-align:center;margin-top:10px;"></p>
    <canvas id="snapCanvas" style="display:none;"></canvas>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBujiz5R1qEHcLvlMp9fQIViIMuWs3gRZk",
      authDomain: "cam-attendance-a4881.firebaseapp.com",
      projectId: "cam-attendance-a4881",
      storageBucket: "cam-attendance-a4881.appspot.com",
      messagingSenderId: "344849505667",
      appId: "1:344849505667:web:9a8ddb0a009f458fca2ab6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const STATUS_URL = "http://localhost:5000/status";
    const ENROLL_URL = "http://localhost:5000/enroll";

    const video = document.getElementById("video");
    const captureBtn = document.getElementById("captureBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const retakeBtn = document.getElementById("retakeBtn");
    const existingImg = document.getElementById("existingImg");
    const statusMsg = document.getElementById("statusMsg");
    const backBtn = document.getElementById("backBtn");
    const snapCanvas = document.getElementById("snapCanvas");
    const snapCtx = snapCanvas.getContext("2d");

    let stream = null;
    let capturedData = null;
    let currentStudent = null;
    let firstTimeEnrollment = true; // determines if back button should show

    existingImg.onerror = () => {
      existingImg.src = "https://placehold.co/260x260?text=No+Photo";
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user || !user.email) { window.location.href = "index.html"; return; }
      if (!user.email.endsWith("@nmamit.in")) { await signOut(auth); window.location.href="index.html"; return;}

      localStorage.setItem("currentUserUid", user.uid);
      localStorage.setItem("currentUserEmail", user.email);

      try {
        const r = await fetch(`${STATUS_URL}?userId=${user.uid}`);
        const data = await r.json();

        if (!data.profileSaved) return window.location.href = "form.html";

        currentStudent = data.student_info;

        if (data.photoEnrolled) {
          firstTimeEnrollment = false;
          backBtn.style.display = "inline-block"; // show back button only if already enrolled (edit mode)
        }

        existingImg.src = data.enrollment?.url_frontal 
          || "https://placehold.co/260x260?text=No+Photo";

      } catch (err) {
        statusMsg.textContent = "Status error: " + err.message;
      }

      startCamera();
    });

    backBtn.addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width:480, height:480, facingMode:"user" }
        });
        video.srcObject = stream;

      } catch (err) {
        statusMsg.textContent = "Camera blocked: " + err.message;
      }
    }

    captureBtn.addEventListener("click", () => {
      if (!video.videoWidth) { statusMsg.textContent = "Camera not ready"; return; }

      snapCanvas.width = video.videoWidth;
      snapCanvas.height = video.videoHeight;

      snapCtx.save();
      snapCtx.translate(video.videoWidth, 0);
      snapCtx.scale(-1, 1);
      snapCtx.drawImage(video, 0, 0);
      snapCtx.restore();

      capturedData = snapCanvas.toDataURL("image/jpeg", 0.95);
      statusMsg.textContent = "Captured!";
      uploadBtn.disabled = false;
    });

    retakeBtn.addEventListener("click", () => {
      capturedData = null;
      uploadBtn.disabled = true;
      statusMsg.textContent = "Retake your photo";
    });

    uploadBtn.addEventListener("click", async () => {
      if (!capturedData) return alert("Capture first!");

      const payload = {
        userId: localStorage.getItem("currentUserUid"),
        usn: currentStudent.usn,
        studentName: currentStudent.student_name,
        studentBranch: currentStudent.student_branch,
        studentSection: currentStudent.student_section,
        image: capturedData
      };

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading…";

      try {
        const r = await fetch(ENROLL_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const data = await r.json();

        if (data.status === "success") {
          existingImg.src = data.url_frontal;
          statusMsg.textContent = "Enrollment successful.";

          // if first time → go to dashboard
          setTimeout(() => window.location.href = "dashboard.html", 700);

        } else {
          statusMsg.textContent = "Server error: " + data.error;
        }

      } catch (err) {
        statusMsg.textContent = "Network error: " + err.message;
      }

      uploadBtn.textContent = "Upload & Save";
      uploadBtn.disabled = false;
    });

    window.addEventListener("beforeunload", () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
    });
  </script>
</body>
</html>
